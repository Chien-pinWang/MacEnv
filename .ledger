
ledger='~/prj/MacBookPro/ledger/Chien-pinWang.ledger'

alias lBal="ledger -f $ledger -B balance ^Assets ^Liabilities"
alias lNew="vi $ledger"
alias lCashBal="ledger -f $ledger balance -R 'SCSB Saving' Expenses:Cash"

function getPeriodBeginEnd() {
    period=$1
    case $period in
    "week")             # Last 7 days
        periodBegin=$(date -v-7d +%Y-%m-%d)
        periodEnd=$(date -v+1d +%Y-%m-%d)
        ;;
    "wtd")              # Week to date
        periodBegin=$(date -vsunday +%Y-%m-%d)
        periodEnd=$(date -v+1d +%Y-%m-%d)
        ;;
    "lastweek")         # Last week
        periodBegin=$(date -v-7d -vsunday +%Y-%m-%d)
        periodEnd=$(date -v-7d -vsaturday -v+1d +%Y-%m-%d)
        ;;
    "month")            # Last 30 days
        periodBegin=$(date -v-30d +%Y-%m-%d)
        periodEnd=$(date -v+1d +%Y-%m-%d)
        ;;
    "mtd")              # Month to date
        periodBegin=$(date +%Y-%m-01)
        periodEnd=$(date -v+1d +%Y-%m-%d)
        ;;
    "lastmonth")        # Last month
        periodBegin=$(date -v-1m -v1d +%Y-%m-%d)
        periodEnd=$(date -v1d +%Y-%m-%d)
        ;;
    *)                  # Today
        periodBegin=$(date +%Y-%m-%d)
        periodEnd=$(date -v+1d +%Y-%m-%d)
        ;;
    esac

    echo "$periodBegin $periodEnd"
}

function lCash () {
    periodRange=$(getPeriodBeginEnd "$1")
    # echo "Debug: $periodRange"
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    ledger -f "$ledger" register Expenses:Cash -b "$periodB" -e "$periodE" -R
}

function lSCSB () {
    periodRange=$(getPeriodBeginEnd "$1")
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    ledger -f "$ledger" register Liabilities:Card:SCSB -b "$periodB" -e "$periodE"
}

function lTSCB () {
    periodRange=$(getPeriodBeginEnd "$1")
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    ledger -f "$ledger" register Liabilities:Card:TSCB -b "$periodB" -e "$periodE"
}

function lSaving () {
    periodRange=$(getPeriodBeginEnd "$1")
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    ledger -f "$ledger" register "SCSB Saving" -b "$periodB" -e "$periodE"
}

function lExp () {
    periodRange=$(getPeriodBeginEnd "$1")
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    ledger -f "$ledger" balance -R Expenses and not \(Expenses:Cash or ^Budget:Expenses\) --depth 2 -b "$periodB" -e "$periodE"
    read -p "Press any key to continue..." -n 1
    ledger -f "$ledger" register -R Expenses and not \(Expenses:Cash or ^Budget:Expenses\) -b "$periodB" -e "$periodE"
}

function lDebt () {
    periodRange=$(getPeriodBeginEnd "$1")
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    ledger -f "$ledger" balance ^Liabilities -b 2017/03/01 -e "$periodE"
}

function lBudget () {                       # Budget always run mtd
    periodRange=$(getPeriodBeginEnd mtd)
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    if [ -z $1 ]
    then
        ledger -f "$ledger" register "expr" "payee =~ /April Expense Budget/" --no-pager
        ledger -f "$ledger" balance ^Budget:Expenses -b "$periodB" -e "$periodE"
    else
        ledger -f "$ledger" register Budget:Expenses:"$1" -b "$periodB" -e "$periodE"
    fi
}

function lUnbudgeted () {
    periodRange=$(getPeriodBeginEnd mtd)
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}
    ledger -f "$ledger" register tag\(unbudgeted\) -b "$periodB" -e "$periodE"
}

# The script is an adopted version from https://www.sundialdreams.com/report-scripts-for-ledger-cli-with-gnuplot/
# Here are what I changed:
#   0. At the LEDGER_TERM ine, use 'x11' instead of 'qt'
#   1. At the ledger command line, added '-R' to report real transactions
#   2. At the ledger command line, change -W to -D for daily total
#   3. At the gnuplot command line, set title to 'Daily $@'
#   4. At the gnuplot command line, plot xticlabels with strftime to '%b %d' for 'Month date', rather than just '%b' for 'Month'
#   5. At the gnuplot command line, plot font 'Courier,12' instead of 'Courier,8'

function dailyplot () {
    if [ -z "$LEDGER_TERM" ]; then
        # LEDGER_TERM="x11 size 1280,720 persist"
        LEDGER_TERM="x11 size 640,360 persist"
    fi

    periodRange=$(getPeriodBeginEnd mtd)
    periodB=${periodRange:0:10}
    periodE=${periodRange:11}

    ledger -j -R reg "$@" -D -b "$periodB" -e "$periodE" --collapse --plot-amount-format="%(format_date(date, \"%Y-%m-%d\")) %(abs(quantity(scrub(display_amount))))\n" > ledgeroutput1.tmp

    (cat <<EOF) | gnuplot
        set terminal $LEDGER_TERM
        set style data histogram
        set style histogram clustered gap 1
        set style fill transparent solid 0.4 noborder
        set xtics nomirror scale 0 center
        set ytics add ('' 0) scale 0
        set border 1
        set grid ytics
        set title "Daily $@"
        set ylabel "Amount"
        plot "ledgeroutput1.tmp" using 2:xticlabels(strftime('%b %d', strptime('%Y-%m-%d', strcol(1)))) notitle linecolor rgb "light-turquoise", '' using 0:2:2 with labels font "Courier,12" offset 0,0.5 textcolor linestyle 0 notitle
EOF

    rm ledgeroutput*.tmp
}

